<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIN Decoder Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>VIN Decoder Test</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="vin" class="form-label">VIN</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="vin" name="vin" 
                               placeholder="Enter 17-character VIN" maxlength="17">
                        <button type="button" class="btn btn-outline-secondary" id="decodeVinBtn" 
                                onclick="decodeVIN()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div id="vinStatus" class="mt-2"></div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="year" class="form-label">Year</label>
                        <input type="text" class="form-control" id="year" name="year">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="make" class="form-label">Make</label>
                        <input type="text" class="form-control" id="make" name="make">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="model" class="form-label">Model</label>
                        <input type="text" class="form-control" id="model" name="model">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="trim" class="form-label">Trim</label>
                        <input type="text" class="form-control" id="trim" name="trim">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="engine" class="form-label">Engine</label>
                        <input type="text" class="form-control" id="engine" name="engine">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="transmission" class="form-label">Transmission</label>
                        <input type="text" class="form-control" id="transmission" name="transmission">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="body_style" class="form-label">Body Style</label>
                        <input type="text" class="form-control" id="body_style" name="body_style">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="drivetrain" class="form-label">Drivetrain</label>
                        <input type="text" class="form-control" id="drivetrain" name="drivetrain">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="fuel_type" class="form-label">Fuel Type</label>
                        <input type="text" class="form-control" id="fuel_type" name="fuel_type">
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <h3>Console Output</h3>
                <div id="consoleOutput" class="border p-3 bg-light" style="height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Override console.log to display in the page
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        function addToConsole(message, type = 'log') {
            const output = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-danger' : type === 'warn' ? 'text-warning' : 'text-dark';
            output.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '));
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole(args.join(' '), 'warn');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };
        
        // VIN Decoding Function
        async function decodeVIN() {
            const vinInput = document.getElementById('vin');
            const vinStatus = document.getElementById('vinStatus');
            const decodeBtn = document.getElementById('decodeVinBtn');
            
            const vin = vinInput.value.trim();
            
            if (!vin) {
                vinStatus.innerHTML = '<div class="alert alert-warning">Please enter a VIN to decode.</div>';
                return;
            }
            
            if (vin.length < 10) {
                vinStatus.innerHTML = '<div class="alert alert-warning">VIN must be at least 10 characters long.</div>';
                return;
            }
            
            // Show loading state
            decodeBtn.disabled = true;
            decodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            vinStatus.innerHTML = '<div class="alert alert-info">Decoding VIN...</div>';
            
            try {
                const response = await fetch(`/vehicle/decode/${vin}`);
                const vehicleData = await response.json();
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                console.log('Vehicle data received:', vehicleData);
                
                if (response.ok && vehicleData) {
                    // Auto-populate fields with decoded data
                    const fields = [
                        { api: 'year', element: 'year' },
                        { api: 'make', element: 'make' },
                        { api: 'model', element: 'model' },
                        { api: 'trim', element: 'trim' },
                        { api: 'engine_displacement', element: 'engine', suffix: 'L' },
                        { api: 'transmission_type', element: 'transmission' },
                        { api: 'body_style', element: 'body_style' },
                        { api: 'drivetrain', element: 'drivetrain' },
                        { api: 'fuel_type', element: 'fuel_type' }
                    ];
                    
                    fields.forEach(field => {
                        const element = document.getElementById(field.element);
                        if (element && vehicleData[field.api]) {
                            const value = vehicleData[field.api] + (field.suffix || '');
                            element.value = value;
                            console.log(`Set ${field.element} to: ${value}`);
                        } else if (!element) {
                            console.warn(`Element not found: ${field.element}`);
                        } else {
                            console.log(`No data for ${field.api}: ${vehicleData[field.api]}`);
                        }
                    });
                    
                    vinStatus.innerHTML = '<div class="alert alert-success">Vehicle information loaded successfully!</div>';
                } else {
                    vinStatus.innerHTML = '<div class="alert alert-warning">VIN not found or invalid. Please check the VIN and try again.</div>';
                }
            } catch (error) {
                console.error('VIN decoding error:', error);
                vinStatus.innerHTML = '<div class="alert alert-danger">Error decoding VIN. Please try again.</div>';
            } finally {
                // Reset button state
                decodeBtn.disabled = false;
                decodeBtn.innerHTML = '<i class="fas fa-search"></i>';
            }
        }
        
        // Auto-decode VIN when user finishes typing (with debounce)
        let vinDecodeTimeout;
        document.getElementById('vin').addEventListener('input', function() {
            console.log('VIN input event triggered');
            clearTimeout(vinDecodeTimeout);
            const vin = this.value.trim();
            console.log('VIN length:', vin.length, 'VIN value:', vin);
            
            if (vin.length >= 17) {
                console.log('VIN length >= 17, setting timeout for auto-decode');
                vinDecodeTimeout = setTimeout(() => {
                    console.log('Auto-decoding VIN:', vin);
                    decodeVIN();
                }, 1000); // Wait 1 second after user stops typing
            }
        });
        
        // Auto-decode on page load
        window.addEventListener('load', function() {
            console.log('Page loaded, auto-decoding VIN...');
            setTimeout(decodeVIN, 1000);
        });
    </script>
</body>
</html> 