<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Inspection - CheckMate Virtue</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-pass { color: #28a745; }
        .status-recommended { color: #ffc107; }
        .status-required { color: #dc3545; }
        .step-header { background-color: #f8f9fa; }
        .subcategory-header { background-color: #e9ecef; }
        .item-row { border-bottom: 1px solid #dee2e6; }
        .photo-preview { max-width: 150px; max-height: 150px; }
        .progress-bar { height: 8px; }
        .vehicle-info-card { 
            background-color: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 0.375rem; 
            padding: 1rem; 
        }
        .vehicle-info-item { 
            margin-bottom: 0.5rem; 
            font-size: 0.875rem; 
        }
        .inspector-info-card {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .validation-error {
            display: none;
            margin-bottom: 1rem;
        }
        .field-error {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Validation Error Container -->
        <div id="validation-error-container" data-testid="validation-error" class="alert alert-danger validation-error" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="validation-error-message"></span>
        </div>

        <div class="row">
            <!-- Sidebar with Progress -->
            <div class="col-md-3 bg-light p-3">
                <h4 class="mb-4">
                    <i class="fas fa-clipboard-check"></i>
                    Vehicle Inspection
                </h4>
                
                <!-- Inspector Information -->
                <div class="inspector-info-card" data-testid="inspection-form">
                    <h6><i class="fas fa-user"></i> Inspector Information</h6>
                    <div class="mb-3">
                        <label for="inspector_name" class="form-label">Inspector Name *</label>
                        <input type="text" id="inspector_name" data-testid="inspector-name" class="form-control" placeholder="Enter inspector name" required>
                    </div>
                    <div class="mb-3">
                        <label for="inspector_id" class="form-label">Inspector ID *</label>
                        <input type="text" id="inspector_id" data-testid="inspector-id" class="form-control" placeholder="Enter inspector ID" required>
                    </div>
                    <div class="mb-3">
                        <label for="inspection_title" class="form-label">Inspection Title *</label>
                        <input type="text" id="inspection_title" data-testid="inspection-title" class="form-control" placeholder="Enter inspection title" required>
                    </div>
                </div>

                <!-- VIN Input -->
                <div class="mb-4">
                    <label for="vin" class="form-label">VIN Number</label>
                    <input type="text" id="vin" data-testid="vin-input" class="form-control" placeholder="Enter VIN for auto-fill">
                    <div class="mt-2">
                        <button type="button" id="decode-vin" data-testid="decode-vin" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-search"></i> Decode VIN
                        </button>
                    </div>
                </div>

                <!-- Vehicle Info Display -->
                <div id="vehicle-info" data-testid="vehicle-info" class="mb-4 vehicle-info-card" style="display: none;">
                    <h6><i class="fas fa-car"></i> Vehicle Information</h6>
                    <div id="vehicle-details" class="small text-muted"></div>
                </div>

                <!-- Progress -->
                <div class="mb-4">
                    <h6>Progress</h6>
                    <div class="progress mb-2">
                        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small id="progress-text">0% Complete</small>
                </div>

                <!-- Steps Navigation -->
                <div class="mb-4">
                    <h6>Inspection Sections</h6>
                    <div id="steps-nav"></div>
                </div>

                <!-- Save Button -->
                <div class="mb-4">
                    <button type="button" id="save-inspection" data-testid="save-inspection" class="btn btn-success w-100">
                        <i class="fas fa-save"></i> Save Inspection
                    </button>
                </div>

                <!-- Finalize Button -->
                <div class="mb-4">
                    <button type="button" id="finalize-inspection" data-testid="finalize-inspection" class="btn btn-warning w-100">
                        <i class="fas fa-lock"></i> Finalize Inspection
                    </button>
                </div>

                <!-- Report Generation Buttons -->
                <div class="mb-4">
                    <button type="button" id="generate-report" data-testid="generate-report" class="btn btn-info w-100 mb-2">
                        <i class="fas fa-file-alt"></i> Generate HTML Report
                    </button>
                    <button type="button" id="generate-pdf-report" data-testid="generate-pdf-report" class="btn btn-secondary w-100">
                        <i class="fas fa-file-pdf"></i> Generate PDF Report
                    </button>
                </div>

                <!-- Status Indicator -->
                <div class="mb-4">
                    <div id="inspection-status" data-testid="inspection-status" class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Status: <span id="status-text">Draft</span>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 p-4">
                <div id="inspection-content">
                    <!-- Content will be dynamically loaded -->
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Upload Modal -->
    <div class="modal fade" id="photoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Photo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="photo-form">
                        <div class="mb-3">
                            <label for="photo-file" class="form-label">Select Photo</label>
                            <input type="file" id="photo-file" class="form-control" accept="image/*" required>
                        </div>
                        <div class="mb-3">
                            <label for="camera-input" class="form-label">Or Take Photo</label>
                            <input type="file" id="camera-input" class="form-control" accept="image/*" capture="environment">
                        </div>
                        <div id="upload-area" class="border-2 border-dashed p-4 text-center" style="border-style: dashed;">
                            <i class="fas fa-cloud-upload-alt fa-2x text-muted"></i>
                            <p class="mt-2">Drag and drop photo here or click to select</p>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="uploadPhoto()">Upload Photo</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let inspectionTemplate = {{ template | tojson }};
        let currentStep = 0;
        let inspectionData = {
            id: null,
            title: '',
            industry_info: {
                name: 'Automotive',
                type: 'automotive'
            },
            inspector_name: '',
            inspector_id: '',
            vin: '',
            vehicle_id: null,
            date: new Date().toISOString(),
            industry_type: 'automotive',
            categories: [],
            status: 'draft'
        };
        let inspectionId = null;
        let currentPhotoItem = null;

        // Initialize the inspection form
        document.addEventListener('DOMContentLoaded', function() {
            loadInspectionTemplate();
            setupEventListeners();
            createInspection();
        });

        function loadInspectionTemplate() {
            const content = document.getElementById('inspection-content');
            const stepsNav = document.getElementById('steps-nav');
            
            content.innerHTML = '';
            stepsNav.innerHTML = '';
            
            // Convert inspection_points to steps format
            const steps = Object.entries(inspectionTemplate.inspection_points).map(([key, value]) => ({
                name: value.description,
                subcategories: [{
                    name: value.description,
                    items: value.items
                }]
            }));
            
            steps.forEach((step, stepIndex) => {
                // Create step navigation
                const stepNav = document.createElement('div');
                stepNav.className = 'mb-2';
                stepNav.innerHTML = `
                    <button class="btn btn-outline-primary btn-sm w-100 text-start" 
                            onclick="showStep(${stepIndex})">
                        <i class="fas fa-${getStepIcon(step.name)}"></i>
                        ${step.name}
                    </button>
                `;
                stepsNav.appendChild(stepNav);
                
                // Create step content
                const stepContent = document.createElement('div');
                stepContent.id = `step-${stepIndex}`;
                stepContent.className = 'step-content';
                stepContent.style.display = stepIndex === 0 ? 'block' : 'none';
                
                stepContent.innerHTML = `
                    <div class="step-header p-3 mb-4 rounded">
                        <h3><i class="fas fa-${getStepIcon(step.name)}"></i> ${step.name}</h3>
                    </div>
                    ${generateStepContent(step, stepIndex)}
                `;
                
                content.appendChild(stepContent);
            });
            
            showStep(0);
        }

        function getStepIcon(stepName) {
            const icons = {
                'Vehicle Inspection / Maintenance Services': 'tools',
                'Tires & Tire Maintenance': 'tire',
                'Brakes': 'brake',
                'Fluid Leaks': 'droplet',
                'Battery/Starting Check': 'battery',
                'Ignition': 'bolt',
                'Steering & Suspension': 'cogs',
                'Exhaust': 'smoke'
            };
            return icons[stepName] || 'clipboard';
        }

        function generateStepContent(step, stepIndex) {
            let html = '';
            
            step.subcategories.forEach((subcategory, subIndex) => {
                html += `
                    <div class="subcategory-header p-3 mb-3 rounded">
                        <h5><i class="fas fa-folder"></i> ${subcategory.name}</h5>
                    </div>
                    <div class="table-responsive mb-4">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 40%">Item</th>
                                    <th style="width: 20%">Status</th>
                                    <th style="width: 20%">Photo</th>
                                    <th style="width: 20%">Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                subcategory.items.forEach((item, itemIndex) => {
                    const itemId = `${stepIndex}-${subIndex}-${itemIndex}`;
                    html += `
                        <tr class="item-row" data-testid="inspection-item" data-step="${step.name}" data-subcategory="${subcategory.name}" data-item="${item}">
                            <td>
                                <label class="form-label">
                                    ${item}
                                </label>
                            </td>
                            <td>
                                <select class="form-select form-select-sm status-select" id="status-${itemId}" data-testid="status-select">
                                    <option value="">Select Status</option>
                                    <option value="pass" class="status-pass" data-testid="status-pass">✅ Pass</option>
                                    <option value="recommended" class="status-recommended" data-testid="status-recommended">⚠️ Recommended</option>
                                    <option value="required" class="status-required" data-testid="status-required">❌ Required</option>
                                </select>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-secondary photo-btn" data-testid="photo-upload"
                                        onclick="openPhotoModal('${step.name}', '${subcategory.name}', '${item}')">
                                    <i class="fas fa-camera"></i>
                                </button>
                                <div id="photo-${itemId}" class="mt-1" data-testid="photo-thumbnail"></div>
                            </td>
                            <td>
                                <textarea class="form-control form-control-sm notes-input" data-testid="notes-input"
                                          rows="2" placeholder="Notes..."></textarea>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            return html;
        }

        function showStep(stepIndex) {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Show selected step
            const stepContent = document.getElementById(`step-${stepIndex}`);
            if (stepContent) {
                stepContent.style.display = 'block';
                currentStep = stepIndex;
            }
            
            // Update navigation
            document.querySelectorAll('#steps-nav button').forEach((btn, index) => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
                if (index === stepIndex) {
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-primary');
                }
            });
            
            updateProgress();
        }

        function updateProgress() {
            const totalItems = document.querySelectorAll('.item-row').length;
            const completedItems = document.querySelectorAll('.status-select').length;
            const percentage = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
            
            document.getElementById('progress-bar').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = `${percentage}% Complete`;
        }

        function setupEventListeners() {
            // Status select change
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('status-select')) {
                    updateProgress();
                }
            });

            // Inspector fields
            document.getElementById('inspector_name').addEventListener('input', function() {
                inspectionData.inspector_name = this.value;
                // Clear validation error when user starts typing
                if (this.value.trim().length > 0) {
                    hideValidationError();
                    highlightField('inspector_name', true);
                }
            });

            document.getElementById('inspector_id').addEventListener('input', function() {
                inspectionData.inspector_id = this.value;
                // Clear validation error when user starts typing
                if (this.value.trim().length > 0) {
                    hideValidationError();
                    highlightField('inspector_id', true);
                }
            });

            document.getElementById('inspection_title').addEventListener('input', function() {
                inspectionData.title = this.value;
                // Clear validation error when user starts typing
                if (this.value.trim().length > 0) {
                    hideValidationError();
                    highlightField('inspection_title', true);
                }
            });

            // VIN decode button
            document.getElementById('decode-vin').addEventListener('click', decodeVIN);
            
            // Auto-decode VIN when user finishes typing (with debounce)
            let vinDecodeTimeout;
            document.getElementById('vin').addEventListener('input', function() {
                clearTimeout(vinDecodeTimeout);
                const vin = this.value.trim();
                inspectionData.vin = vin;
                
                // Clear validation error when user starts typing
                if (vin.length > 0) {
                    hideValidationError();
                    highlightField('vin', true);
                }
                
                if (vin.length >= 17) {
                    vinDecodeTimeout = setTimeout(() => {
                        decodeVIN();
                    }, 1000); // Wait 1 second after user stops typing
                }
            });

            // Save button
            document.getElementById('save-inspection').addEventListener('click', saveInspection);
        }

        async function createInspection() {
            try {
                const response = await fetch('/api/inspections', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: inspectionData.title || 'Vehicle Inspection',
                        industry_type: 'automotive',
                        industry_info: {
                            industry_type: 'automotive',
                            facility_name: '',
                            location: '',
                            contact_person: '',
                            phone: '',
                            email: ''
                        },
                        inspector_name: inspectionData.inspector_name || 'Inspector',
                        inspector_id: inspectionData.inspector_id || 'TECH001',
                        vehicle_info: {
                            vin: inspectionData.vin
                        }
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    inspectionId = result.inspection_id;
                    inspectionData.id = inspectionId;
                    console.log('Inspection created:', inspectionId);
                } else {
                    const errorData = await response.json();
                    let errorMessage = 'Failed to create inspection';
                    
                    // Handle validation errors from server
                    if (response.status === 422) {
                        if (errorData.detail && Array.isArray(errorData.detail)) {
                            const validationErrors = errorData.detail.map(err => 
                                `${err.loc ? err.loc.join('.') + ': ' : ''}${err.msg}`
                            );
                            errorMessage = validationErrors.join('; ');
                        } else if (errorData.detail) {
                            errorMessage = errorData.detail;
                        }
                    } else if (errorData.detail) {
                        errorMessage = errorData.detail;
                    }
                    
                    showValidationError(errorMessage);
                    console.error('Failed to create inspection:', errorMessage);
                }
            } catch (error) {
                console.error('Error creating inspection:', error);
                showValidationError('Network error: Unable to create inspection. Please check your connection and try again.');
            }
        }

        async function createInspectionWithVINData(vehicleData) {
            try {
                // If inspection already exists, update it with VIN data
                if (inspectionId) {
                    const response = await fetch(`/api/inspections/${inspectionId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ...inspectionData,
                            vehicle_info: {
                                vin: inspectionData.vin,
                                year: vehicleData.year,
                                make: vehicleData.make,
                                model: vehicleData.model,
                                trim: vehicleData.trim,
                                engine: vehicleData.engine_displacement,
                                transmission: vehicleData.transmission_type,
                                body_style: vehicleData.body_style,
                                fuel_type: vehicleData.fuel_type,
                                drivetrain: vehicleData.drivetrain,
                                country_of_origin: vehicleData.country_of_origin,
                                plant_code: vehicleData.plant_code,
                                serial_number: vehicleData.serial_number
                            }
                        })
                    });

                    if (response.ok) {
                        console.log('Inspection updated with VIN data');
                    } else {
                        console.error('Failed to update inspection with VIN data');
                    }
                } else {
                    // Create new inspection with VIN data
                    const response = await fetch('/api/inspections', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            title: inspectionData.title || 'Vehicle Inspection',
                            industry_type: 'automotive',
                            industry_info: {
                                industry_type: 'automotive',
                                facility_name: '',
                                location: '',
                                contact_person: '',
                                phone: '',
                                email: ''
                            },
                            inspector_name: inspectionData.inspector_name || 'Inspector',
                            inspector_id: inspectionData.inspector_id || 'TECH001',
                            vehicle_info: {
                                vin: inspectionData.vin,
                                year: vehicleData.year,
                                make: vehicleData.make,
                                model: vehicleData.model,
                                trim: vehicleData.trim,
                                engine: vehicleData.engine_displacement,
                                transmission: vehicleData.transmission_type,
                                body_style: vehicleData.body_style,
                                fuel_type: vehicleData.fuel_type,
                                drivetrain: vehicleData.drivetrain,
                                country_of_origin: vehicleData.country_of_origin,
                                plant_code: vehicleData.plant_code,
                                serial_number: vehicleData.serial_number
                            }
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        inspectionId = result.inspection_id;
                        inspectionData.id = inspectionId;
                        console.log('Inspection created with VIN data:', inspectionId);
                    } else {
                        console.error('Failed to create inspection with VIN data');
                    }
                }
            } catch (error) {
                console.error('Error creating/updating inspection with VIN data:', error);
            }
        }

        async function decodeVIN() {
            const vin = document.getElementById('vin').value.trim();
            if (!vin) {
                alert('Please enter a VIN number');
                return;
            }

            try {
                const response = await fetch(`/vehicle/decode/${vin}`);
                if (response.ok) {
                    const vehicleData = await response.json();
                    displayVehicleInfo(vehicleData);
                    inspectionData.vin = vin;
                    
                    // Create or update inspection with VIN data
                    await createInspectionWithVINData(vehicleData);
                } else {
                    alert('Failed to decode VIN');
                }
            } catch (error) {
                console.error('Error decoding VIN:', error);
                alert('Error decoding VIN');
            }
        }

        function displayVehicleInfo(vehicleData) {
            const vehicleInfo = document.getElementById('vehicle-info');
            const vehicleDetails = document.getElementById('vehicle-details');
            
            vehicleDetails.innerHTML = `
                <div class="vehicle-info-item"><strong>Year:</strong> ${vehicleData.year || 'N/A'}</div>
                <div class="vehicle-info-item"><strong>Make:</strong> ${vehicleData.make || 'N/A'}</div>
                <div class="vehicle-info-item"><strong>Model:</strong> ${vehicleData.model || 'N/A'}</div>
                <div class="vehicle-info-item"><strong>Trim:</strong> ${vehicleData.trim || 'N/A'}</div>
                <div class="vehicle-info-item"><strong>Engine:</strong> ${vehicleData.engine_displacement || 'N/A'}</div>
                <div class="vehicle-info-item"><strong>Transmission:</strong> ${vehicleData.transmission_type || 'N/A'}</div>
                <div class="vehicle-info-item"><strong>Body Style:</strong> ${vehicleData.body_style || 'N/A'}</div>
            `;
            
            vehicleInfo.style.display = 'block';
        }

        function openPhotoModal(step, subcategory, item) {
            currentPhotoItem = { step, subcategory, item };
            const modal = new bootstrap.Modal(document.getElementById('photoModal'));
            modal.show();
        }

        async function uploadPhoto() {
            if (!currentPhotoItem) return;

            const fileInput = document.getElementById('photo-file');
            const cameraInput = document.getElementById('camera-input');
            
            let file = fileInput.files[0] || cameraInput.files[0];
            if (!file) {
                alert('Please select a photo');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('step', currentPhotoItem.step);
            formData.append('subcategory', currentPhotoItem.subcategory);
            formData.append('item', currentPhotoItem.item);

            try {
                const response = await fetch(`/api/inspections/${inspectionId}/photos`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Close modal using Bootstrap API
                    const modal = bootstrap.Modal.getInstance(document.getElementById('photoModal'));
                    modal.hide();
                    
                    // Update the UI to show the uploaded photo
                    updatePhotoDisplay(currentPhotoItem.step, currentPhotoItem.subcategory, currentPhotoItem.item, result.photo_url || result.filename);
                    
                    alert('Photo uploaded successfully');
                } else {
                    const errorData = await response.json();
                    alert('Failed to upload photo: ' + (errorData.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error uploading photo:', error);
                alert('Error uploading photo');
            }
        }

        function updatePhotoDisplay(step, subcategory, item, photoUrl) {
            // Find the correct item row and update its photo display
            const itemRows = document.querySelectorAll('.item-row');
            itemRows.forEach(row => {
                if (row.dataset.step === step && 
                    row.dataset.subcategory === subcategory && 
                    row.dataset.item === item) {
                    
                    const photoContainer = row.querySelector('.photo-btn').nextElementSibling;
                    if (photoContainer) {
                        photoContainer.innerHTML = `
                            <img src="${photoUrl.startsWith('/') ? photoUrl : '/static/uploads/' + photoUrl}" 
                                 class="img-thumbnail" style="max-width: 50px; max-height: 50px;" 
                                 alt="Uploaded photo">
                        `;
                    }
                }
            });
        }

        function loadExistingPhotos() {
            // Load existing photos from inspection data
            if (inspectionData && inspectionData.categories) {
                inspectionData.categories.forEach(category => {
                    category.items.forEach(item => {
                        if (item.photo_url) {
                            updatePhotoDisplay(category.name, category.name, item.name, item.photo_url);
                        }
                    });
                });
            }
        }

        // Validation helper functions
        function showValidationError(message) {
            const container = document.getElementById('validation-error-container');
            const messageSpan = document.getElementById('validation-error-message');
            messageSpan.textContent = message;
            container.style.display = 'block';
            container.classList.remove('d-none');
        }

        function hideValidationError() {
            const container = document.getElementById('validation-error-container');
            container.style.display = 'none';
            container.classList.add('d-none');
        }

        function highlightField(fieldId, isValid) {
            const field = document.getElementById(fieldId);
            if (field) {
                if (!isValid) {
                    field.classList.add('field-error');
                    field.setAttribute('aria-invalid', 'true');
                } else {
                    field.classList.remove('field-error');
                    field.setAttribute('aria-invalid', 'false');
                }
            }
        }

        function validateForm() {
            let isValid = true;
            let errorMessages = [];

            // Validate inspector name
            const inspectorName = inspectionData.inspector_name.trim();
            if (!inspectorName) {
                errorMessages.push('Inspector name is required');
                highlightField('inspector_name', false);
                isValid = false;
            } else {
                highlightField('inspector_name', true);
            }

            // Validate inspector ID
            const inspectorId = inspectionData.inspector_id.trim();
            if (!inspectorId) {
                errorMessages.push('Inspector ID is required');
                highlightField('inspector_id', false);
                isValid = false;
            } else {
                highlightField('inspector_id', true);
            }

            // Validate inspection title
            const title = inspectionData.title.trim();
            if (!title) {
                errorMessages.push('Inspection title is required');
                highlightField('inspection_title', false);
                isValid = false;
            } else {
                highlightField('inspection_title', true);
            }

            // Validate VIN if provided
            const vin = inspectionData.vin.trim();
            if (vin && vin.length !== 17) {
                errorMessages.push('VIN must be exactly 17 characters');
                highlightField('vin', false);
                isValid = false;
            } else if (vin) {
                highlightField('vin', true);
            }

            if (!isValid) {
                showValidationError(errorMessages.join('; '));
            } else {
                hideValidationError();
            }

            return isValid;
        }

        async function saveInspection() {
            // Clear previous validation errors
            hideValidationError();
            
            // Validate required fields
            if (!validateForm()) {
                return;
            }

            if (!inspectionId) {
                // Try to create inspection if it doesn't exist
                try {
                    await createInspection();
                    if (!inspectionId) {
                        showValidationError('Failed to create inspection. Please try again.');
                        return;
                    }
                } catch (error) {
                    console.error('Error creating inspection:', error);
                    showValidationError('Failed to create inspection. Please try again.');
                    return;
                }
            }

            // Collect all inspection data and transform to categories format
            const categories = [];
            const steps = Object.entries(inspectionTemplate.inspection_points);
            
            steps.forEach(([key, stepData]) => {
                const category = {
                    name: stepData.description,
                    description: stepData.description,
                    items: []
                };

                stepData.items.forEach(itemName => {
                    // Find the corresponding row in the DOM
                    const row = document.querySelector(`[data-item="${itemName}"]`);
                    if (row) {
                        const status = row.querySelector('.status-select').value;
                        const notes = row.querySelector('.notes-input').value;
                        const photoContainer = row.querySelector('.photo-btn').nextElementSibling;
                        const photoImg = photoContainer.querySelector('img');
                        const photo_url = photoImg ? photoImg.src : null;

                        category.items.push({
                            name: itemName,
                            grade: status || 'N/A',
                            notes: notes,
                            photos: photo_url ? [photo_url] : []
                        });
                    }
                });

                categories.push(category);
            });

            // Update inspection data with categories format
            inspectionData.categories = categories;
            inspectionData.date = new Date().toISOString();

            try {
                const response = await fetch(`/api/inspections/${inspectionId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(inspectionData)
                });

                if (response.ok) {
                    const result = await response.json();
                    hideValidationError();
                    alert('Inspection saved successfully!');
                    window.location.href = '/inspections';
                } else {
                    const errorData = await response.json();
                    let errorMessage = 'Failed to save inspection';
                    
                    // Handle validation errors from server
                    if (response.status === 422) {
                        if (errorData.detail && Array.isArray(errorData.detail)) {
                            const validationErrors = errorData.detail.map(err => 
                                `${err.loc ? err.loc.join('.') + ': ' : ''}${err.msg}`
                            );
                            errorMessage = validationErrors.join('; ');
                        } else if (errorData.detail) {
                            errorMessage = errorData.detail;
                        }
                    } else if (errorData.detail) {
                        errorMessage = errorData.detail;
                    }
                    
                    showValidationError(errorMessage);
                }
            } catch (error) {
                console.error('Error saving inspection:', error);
                showValidationError('Network error: Unable to save inspection. Please check your connection and try again.');
            }
        }
    </script>
</body>
</html> 