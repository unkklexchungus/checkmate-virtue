<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIN Decoder Test - Fixed</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/error-handler.js"></script>
    <script src="/static/js/api-client.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>VIN Decoder Test - Fixed Version</h1>
        <p class="text-muted">Testing the updated VIN decoder with proper error handling</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test VIN Decoder</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="vin" class="form-label">VIN Number</label>
                            <input type="text" id="vin" class="form-control" placeholder="Enter VIN (e.g., 1HGBH41JXMN109186)" value="1HGBH41JXMN109186">
                        </div>
                        <button type="button" id="decode-btn" class="btn btn-primary">Decode VIN</button>
                        <button type="button" id="test-error-btn" class="btn btn-warning ms-2">Test Error Handling</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="status" class="alert alert-info">Ready to test</div>
                        <div id="results" class="d-none">
                            <h6>Vehicle Information:</h6>
                            <div id="vehicle-details"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Log</h5>
                    </div>
                    <div class="card-body">
                        <div id="log" class="bg-light p-3" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.875rem;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `alert alert-${type}`;
            statusDiv.textContent = message;
        }

        function displayResults(vehicleData) {
            const resultsDiv = document.getElementById('results');
            const detailsDiv = document.getElementById('vehicle-details');
            
            detailsDiv.innerHTML = `
                <table class="table table-sm">
                    <tr><td><strong>VIN:</strong></td><td>${vehicleData.vin || 'N/A'}</td></tr>
                    <tr><td><strong>Year:</strong></td><td>${vehicleData.year || 'N/A'}</td></tr>
                    <tr><td><strong>Make:</strong></td><td>${vehicleData.make || 'N/A'}</td></tr>
                    <tr><td><strong>Model:</strong></td><td>${vehicleData.model || 'N/A'}</td></tr>
                    <tr><td><strong>Trim:</strong></td><td>${vehicleData.trim || 'N/A'}</td></tr>
                    <tr><td><strong>Engine:</strong></td><td>${vehicleData.engine_displacement || 'N/A'}</td></tr>
                    <tr><td><strong>Transmission:</strong></td><td>${vehicleData.transmission_type || 'N/A'}</td></tr>
                    <tr><td><strong>Body Style:</strong></td><td>${vehicleData.body_style || 'N/A'}</td></tr>
                    <tr><td><strong>Fuel Type:</strong></td><td>${vehicleData.fuel_type || 'N/A'}</td></tr>
                    <tr><td><strong>Drivetrain:</strong></td><td>${vehicleData.drivetrain || 'N/A'}</td></tr>
                </table>
            `;
            
            resultsDiv.classList.remove('d-none');
        }

        document.getElementById('decode-btn').addEventListener('click', async function() {
            const vin = document.getElementById('vin').value.trim();
            if (!vin) {
                updateStatus('Please enter a VIN number', 'warning');
                return;
            }

            log(`Testing VIN decoder with: ${vin}`);
            updateStatus('Decoding VIN...', 'info');

            try {
                // Test using the API client with error handling
                log('Using API client with error handling...');
                const vehicleData = await window.apiClient.decodeVIN(vin);
                
                if (vehicleData) {
                    log('✅ VIN decode successful');
                    log(`Received data: ${JSON.stringify(vehicleData, null, 2)}`);
                    updateStatus('VIN decoded successfully!', 'success');
                    displayResults(vehicleData);
                } else {
                    log('❌ VIN decode returned null/empty data');
                    updateStatus('Failed to decode VIN - no data returned', 'danger');
                }
            } catch (error) {
                log(`❌ Error during VIN decode: ${error.message}`);
                updateStatus(`Error: ${error.message}`, 'danger');
            }
        });

        document.getElementById('test-error-btn').addEventListener('click', async function() {
            log('Testing error handling with invalid VIN...');
            updateStatus('Testing error handling...', 'warning');

            try {
                // Test with an invalid VIN to trigger error handling
                const vehicleData = await window.apiClient.decodeVIN('INVALID_VIN_123');
                
                if (vehicleData) {
                    log('Unexpected: Invalid VIN returned data');
                    updateStatus('Invalid VIN returned data (unexpected)', 'warning');
                } else {
                    log('✅ Error handling working correctly - invalid VIN returned null');
                    updateStatus('Error handling working correctly', 'success');
                }
            } catch (error) {
                log(`✅ Error handling working correctly: ${error.message}`);
                updateStatus('Error handling working correctly', 'success');
            }
        });

        // Test API client initialization
        log('Testing API client initialization...');
        if (window.apiClient) {
            log('✅ API client initialized successfully');
        } else {
            log('❌ API client not initialized');
        }

        // Test error handler initialization
        log('Testing error handler initialization...');
        if (window.errorHandler) {
            log('✅ Error handler initialized successfully');
        } else {
            log('❌ Error handler not initialized');
        }

        log('Test page loaded successfully');
    </script>
</body>
</html>
